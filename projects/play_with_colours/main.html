<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
<script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
<script src="https://rawgit.com/khanduri/colour.js/5ec36ab51cae157fc49cf4c9f38442b7c2507f38/colour.js" type="text/javascript"></script>
<style>
  body {
    color: #444;
  }
  .colour-box-frame {
    margin: 1px;
    text-align: center;
    margin-left: auto;
    margin-right: auto;
  }
  .colour-box-img {
    border: 1px solid #666;
    padding: 50px;
  }
  .colour-box-text {
    font-family: "inherit";
    font-size: 20px;
    border: 1px solid #666;
  }
  #colour-csv {
    width: 90%;
  }
  .colour-input-div {
    margin: 10px 5px 5px 5px;
  }
  .project-widget {
    background-color: #f7f7f9;
    margin: 20px;
    margin-left: auto;
    margin-right: auto;
    padding: 20px;
    border-radius: 15px;
  }
  .tab-options {
    cursor: pointer;
  }
  .filler {
    width: 95%;
  }
</style>
</head>
<body>

  <div class="container">
    <div class="jumbotron">
      <h1>Playing with Colours</h1>
      <br>
      <ul class="nav nav-tabs">
        <li role="presentation" class="tab-options active" id="raw-colour-list"><a>Raw Colour list</a></li>
        <li role="presentation" class="tab-options" id="html-parse"><a>CSS Source Parse</a></li>
      </ul>
      <div id="content-placeholder">
        <div id="content-raw-colour-list">
          <div class="colour-input-div"><input id="colour-csv"></input></div>
          <!-- cat assets/themes/the-minimum/css/constants.scss | grep "#" | sed "s/:/     /g" | sed "s/ //g" | cut -f2 | paste -sd " " - -->
          <div class="colour-input-div"><strong>Sample Input: </strong>#ffffff; #000; #555d50; #474747; #929292; #393939; #bada55;</div>
          <div class="colour-input-div"><button class="btn btn-lg btn-primary" id="colour-process-button">Process</button></div>
        </div>
        <div id="content-html-parse" class="hidden">
          <div class="colour-input-div">
            <textarea id="source-process-text" rows="9" class="filler" placeholder="Paste css source code here .. We'll extract all the colours"></textarea>
          </div>
          <div class="colour-input-div"><button class="btn btn-lg btn-primary" id="source-process-button">Process</button></div>
        </div>
      </div>
    </div>

    <div id="canvas"></div>
  </div>

  <div class="container">
    <div class="project-widget" id="export-colour">
          <div class="colour-input-div"><button class="btn btn-lg btn-primary" id="export-scss-button">Export scss constants</button></div>
          <div class="colour-input-div"><textarea id="export-text" class="filler" rows="9" readonly></textarea></div>
    </div>
  </div>

  <div class="container">
    <div class="project-widget" id="colour-todo">
      <h4>Todo</h4>
    	<ul>
    		<li>Generate complementary / inverted colours based on the input</li>
    		<li>Be able to save colour setup</li>
    		<li>Be able to remove colour boxes</li>
    		<li>Be able to add colour boxes</li>
    		<li>Given a colour, generate gradients</li>
        <li>Given a link fetch all its colours</li>
        <li><strong>In Progress: </strong>Exporting colours functionality</li>
        <s><li>Given a page source fetch all its colours</li></s>
        <s><li>Given a list of colours, generate a grid of colours</li></s>
    	</ul>
    </div>
  </div>

  <div id="colour-box-template" class="colour-box-frame col-md-2 hidden">
    <div class="colour-box-img"></div>
    <div class="colour-box-text"></div>
  </div>

</body>

<script>
  var extractColours = function(str){
    var re = /(#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3})/g;
    var m;
    var colourDict = {};
    while ((m = re.exec(str)) != null) {
      if (m.index === re.lastIndex) {
        re.lastIndex++;
      }
      var colour = fixedLengthColour(m[0]);
      colourDict[colour] = colour;
    }
    var colourArray = [];
    for (var key in colourDict) {
      colourArray.push(key);
    }
    return colourArray;
  }

  var toggleActive = function(selector){
    cleanCanvas();
    $(".tab-options").each(function( index ) {
      $(this).removeClass('active');
    });
    $(selector).addClass('active');
  }

  var fixedLengthColour = function(colour){
    var flColour = colour.replace('#', '').trim();
    if (flColour.length == 3) {
      flColour += flColour;
    }
    return flColour;
  }

  var printColours = function(colours){
      cleanCanvas();
      var printedColours = {};
      for (index in colours) {
        var colour = colours[index].replace('#', '').trim();
        if (colour == "") continue;
        colour = fixedLengthColour(colour).toUpperCase();
        if (!(colour in printedColours)){
          var template = $("#colour-box-template").clone().removeClass('hidden');
          template.attr("id", "#colour-box-template-" + index);
          template.children(".colour-box-text").text('#' + colour);
          template.children(".colour-box-img").css("background-color", colour);
          $('#canvas').append(template);
          printedColours[colour] = colour;
        }
      }
  }

  var cleanCanvas = function() {
    $('#canvas').empty();
    $('#export-text').text('');
  }

  var fetchColourDictFromCanvas = function() {
    var colours = {}
    $('#canvas').children('.colour-box-frame').each(function(index){
      var colour = $(this).children('.colour-box-text').first().text();
      var colourName = Colour(colour).getName();
      if (!(colourName in colours)) {
        colours[colourName] = [];
      }
      colours[colourName].push(colour);
    });
    return colours;
  }

  var printSCSSConstants = function(colours) {
    for (var colourName in colours) {
      for (var index in colours[colourName]) {
        var comment = '';
        if (colours[colourName].length > 1) {
          comment = " // These seem to be dupes! Consider merging with single colour"
        }
        $('#export-text').text('$' + colourName + ': ' + colours[colourName][index] + ';' + comment + '\n' + $('#export-text').text());
      }
    }
  }

  $( document ).ready(function() {
    $('#export-scss-button').click(function(e){
      e.preventDefault();

      $('#export-text').text('');
      var colours = fetchColourDictFromCanvas();
      printSCSSConstants(colours);
    });

    $("#html-parse").click(function (e) {
      e.preventDefault();
      toggleActive(this);
      $('#content-raw-colour-list').addClass('hidden');
      $('#content-html-parse').removeClass('hidden');
    });

    $("#raw-colour-list").click(function (e) {
      e.preventDefault();
      toggleActive(this);
      $('#content-raw-colour-list').removeClass('hidden');
      $('#content-html-parse').addClass('hidden');
    });

    $("#canvas").sortable();
    $("#canvas").disableSelection();

    $("#source-process-button").click(function(event){
      event.preventDefault();
      var str = $('#source-process-text').val();
      var colours = extractColours(str);
      printColours(colours);
    });

    $("#colour-process-button").click(function(event){
      event.preventDefault();
      var colours = $("#colour-csv").val().split(";");
      printColours(colours);
    });
  });
</script>

</html>
